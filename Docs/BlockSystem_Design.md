# 블록 시스템 설계 문서 (Block System Design)

**프로젝트**: MatchBattle
**버전**: 1.0
**작성일**: 2025-12-18
**관련 문서**:
- [BlockData.md](BlockData.md) - 블록 종류 및 데이터
- [CombatSystem_Design.md](CombatSystem_Design.md) - 전투 시스템
- [GameDesign.md](GameDesign.md) - 전체 게임 디자인

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [보드 메커니즘](#보드-메커니즘)
3. [블록 연결 시스템](#블록-연결-시스템)
4. [BlockPool 시스템](#blockpool-시스템)
5. [연쇄 보너스](#연쇄-보너스)
6. [특수 메커니즘](#특수-메커니즘)
7. [구현 우선순위](#구현-우선순위)

---

## 🎯 시스템 개요

> Dungeon Raid 스타일의 경로 연결 방식 + Slay the Spire의 덱 빌딩

### 핵심 개념

```
색상 = 카테고리, 아이콘 = 구체적 효과

예시:
🔴⚔️ 검 (공격 +5) + 🔴🪓 도끼 (공격 +8) + 🔴🔥 화염 (공격 +3 + DOT)
→ 모두 빨간색이므로 연결 가능!
→ 총 효과: 공격 +16 + DOT
```

### 디자인 의도

```
✅ 색상 통일로 시각적 직관성
✅ 다양한 블록 조합으로 전략적 깊이
✅ 블록 빌딩으로 커스터마이징
✅ 경로 연결로 매치 퍼즐의 재미
```

---

## 🎨 보드 메커니즘

### 그리드 구조

```
크기: 8×8 (총 64칸)

┌─────────────────────────┐
│ 🔴 🔵 🟡 🔴 🟤 🔵 🔴 🟢 │
│ 🔵 🔴 🔵 🟤 🔴 🟡 🔵 🔴 │
│ 🟡 🔵 🔴 🔵 🟡 🔴 🟤 🔵 │
│ 🔴 🟤 🔵 🔴 🔵 🟡 🔴 🟤 │
│ 🔵 🔴 🟡 🔵 🔴 🔵 🟡 🔴 │
│ 🟡 🔵 🔴 🟤 🔵 🔴 🔵 🟡 │
│ 🔴 🟡 🔵 🔴 🟤 🔵 🔴 🔵 │
│ 🔵 🔴 🟤 🔵 🔴 🟡 🔵 🔴 │
└─────────────────────────┘

이유:
- 너무 작으면: 전략 부족
- 너무 크면: 시각적 혼란, 성능 저하
- 8×8: 전략성 + 시인성 균형
```

### 블록 생성

```
초기 생성:
- 64칸 전부 BlockPool에서 랜덤 추출
- 색상 분포는 BlockPool 비율 따름

재생성 (블록 제거 후):
1. 블록 드롭 (위→아래 낙하)
2. 빈 칸 BlockPool에서 채우기
3. 계속 플레이 가능하도록 보장

색상 분포 (MVP):
- 🔴 빨강 (공격): 25%
- 🔵 파랑 (방어): 25%
- 🟡 노랑 (골드): 15%
- 🟤 갈색 (특수): 30%
- 🟢 초록 (와일드카드): 5%
```

### 블록 제거 및 드롭

```
1단계: 블록 제거
- 연결된 블록들을 보드에서 제거
- 효과는 제거 전에 이미 적용됨

2단계: 블록 드롭
- 위쪽 블록들이 아래로 낙하
- 중력 시뮬레이션 (위→아래)

3단계: 빈 칸 채우기
- 맨 위 행부터 BlockPool에서 새 블록 생성
- 보드가 다시 8×8로 채워짐

애니메이션:
- 드롭: 0.3초 (부드럽게)
- 생성: 0.1초 (즉시)
- 총 소요: ~0.5초
```

---

## 🔗 블록 연결 시스템

### 입력 방식

```
드래그 연결 (Dungeon Raid 스타일):

1. 블록 터치/클릭 시작
2. 인접한 같은 색 블록으로 드래그
3. 경로 형성 (LineRenderer로 시각화)
4. 드래그 종료 → 효과 발동

특징:
✅ 시간 제한 없음 (순수 턴제)
✅ 깊게 생각하고 최적 경로 선택
✅ 실수하면 되돌리기 가능 (Auto-backtracking)
```

### 연결 규칙

```
기본 규칙:
1. 같은 색상만 연결 가능
2. 인접한 블록만 연결 가능 (8방향)
3. 최소 연결: 1개 (MVP 현재 설정)
4. 같은 블록 중복 방문 불가

8방향 인접:
┌───┬───┬───┐
│ ↖ │ ↑ │ ↗ │
├───┼───┼───┤
│ ← │ ● │ → │
├───┼───┼───┤
│ ↙ │ ↓ │ ↘ │
└───┴───┴───┘

→ 대각선 포함 모든 방향 연결 가능!
```

### Auto-backtracking

```
개념:
- 비인접 블록 선택 시 경로 자동 조정
- 수동 Undo + 자동 되돌리기 통합

동작:
1. 플레이어가 비인접 블록 선택
2. 시스템이 자동으로 이전 블록들 제거
3. 새로운 경로로 자연스럽게 전환

예시:
경로: A → B → C
플레이어 선택: D (B와 인접)
→ 시스템: A → B → D (C 자동 제거)

장점:
✅ 자유로운 경로 그리기
✅ 실수 복구 용이
✅ 직관적인 UX
```

### 경로 시각화

```
LineRenderer:
- 연결된 블록 중심을 잇는 선
- 색상: 블록 색상과 동일
- 굵기: 2-3픽셀
- 부드러운 곡선 (optional)

블록 하이라이트:
- 선택된 블록: 밝게
- 연결 가능한 블록: 약간 밝게
- 연결 불가: 어둡게

피드백:
- 유효한 연결: 초록 테두리
- 유효하지 않음: 빨강 테두리
```

---

## 🎲 BlockPool 시스템

> Slay the Spire의 덱 빌딩과 유사한 블록 풀 관리

### 개념

```
BlockPool = 현재 런에서 사용 가능한 블록 목록

초기 풀:
┌──────────────────────────┐
│ 🔴⚔️ 검 (80%)            │
│ 🔵🛡️ 방패 (80%)          │
│ 🟡💰 금화 (80%)          │
│ 🟤💩 쓰레기 (80%)        │
│ 🟤🧪 포션 (15%)          │
│ 🟤✨ 버프 (5%)           │
│ 🟢⭐ 와일드카드 (5%)     │
└──────────────────────────┘

→ 보드 생성 시 이 풀에서 랜덤 추출
```

### 블록 추가 (빌딩)

```
전투 승리 → 보상 선택:

옵션 1: 블록 추가
┌──────────────────┐
│ 🔴🪓 도끼 블록   │
│ (붉은 블록)       │
│ 공격 +8, 방어 -2 │
└──────────────────┘

추가 후 풀:
- 🔴⚔️ 검 (60%) ← 비율 감소
- 🔴🪓 도끼 (20%) ← 새로 추가
- 🔵🛡️ 방패 (80%)
- ...

→ 덱 빌딩처럼 풀 커스터마이징!
```

### 확률 분포

```
기본 원칙:
- 새 블록 추가 시 같은 색상 비율 조정
- 전체 색상 비율은 유지
- 희귀 블록은 낮은 확률

예시:
초기: 검(80%)
도끼 추가: 검(60%), 도끼(20%)
화염 추가: 검(50%), 도끼(15%), 화염(15%)

→ 빨간 블록 총 비율은 ~25% 유지
```

### 밸런싱

```
블록 풀 크기:
- 초기: 7종
- 최대: 20-30종 (Post-MVP)

추가 규칙:
✅ 같은 블록 중복 추가 가능 (확률 증가)
✅ 특정 색상 집중 가능 (공격 빌드 등)
✅ 균형 잡힌 풀 권장 (공/방/회복)
```

---

## 📈 연쇄 보너스

> 많은 블록을 연결할수록 효과 증가

### 보너스 배율 (Phase 3 예정)

```
블록 개수별 배율:

1개: 30%
2개: 60%
3개: 100% (기준)
4개: 110%
5개: 125%
6개: 150%
7개+: 200%

예시:
🔴⚔️ 검 5개 연결:
- 기본 효과: 5 × 5 = 25
- 5개 보너스: 25 × 1.25 = 31.25
- 최종 데미지: 31

전략적 의미:
✅ 긴 경로 찾기 유도
✅ 짧은 경로도 유효 (유연성)
✅ 보너스는 부가 요소
```

### 현재 상태 (MVP)

```
연쇄 보너스 없음:
- 블록 효과를 단순 합산
- 예: 검 5개 = 5 + 5 + 5 + 5 + 5 = 25

이유:
- MVP 단순화
- 밸런싱 우선 (보너스는 나중에)
- Phase 3에서 추가 예정
```

---

## ✨ 특수 메커니즘

### 와일드카드 블록

```
🟢⭐ 별 (와일드카드):

특징:
- 현재 경로 색상 또는 다른 와일드카드와만 연결 가능
- 생성 확률 낮음 (5%)
- 연결된 색상의 효과 적용

연결 규칙:
1. 경로 색상이 정해진 경우: 해당 색상 또는 와일드카드와만 연결
2. 와일드카드로 시작한 경우: 다음 블록이 경로 색상 결정

예시 1 (일반):
🔴⚔️ 검 → 🟢⭐ 별 → 🔴🪓 도끼
→ 경로 색상 = 빨강
→ 별은 빨간 블록 또는 다른 별과만 연결 가능

예시 2 (와일드카드 시작):
🟢⭐ 별 → 🟢⭐ 별 → 🔴⚔️ 검 → 🔴🪓 도끼
→ 검이 경로 색상을 빨강으로 결정
→ 이후 빨강 또는 별과만 연결 가능

전략적 가치:
✅ 경로 연장에 도움
✅ 와일드카드 체인 가능
⚠️ 자유로운 색상 전환 불가 (밸런스)
```

### 색상 전환 (와일드카드)

```
메커니즘:
- 와일드카드는 현재 경로 색상을 "따라감"
- 경로 시작이 와일드카드면 다음 블록이 색상 결정
- 결정된 색상으로만 경로 유지

제약:
- 와일드카드로 색상 "전환" 불가
- 예: 빨강 → 와일드 → 파랑 (X)
- 와일드카드는 현재 경로 색상과만 연결 (O)
- 예: 빨강 → 와일드 → 빨강 (O)

특수 케이스 (와일드카드 시작):
- 와일드 → 와일드 → 색상: 첫 색상 블록이 경로 결정
- 와일드 → 색상: 즉시 경로 색상 결정

구현:
- 첫 연결 블록 색상 저장 (와일드카드 제외)
- 와일드카드는 현재 경로 색상과 매칭 확인
- 경로 검증 시 색상 일치 확인
```

---

## 📝 구현 우선순위

### MVP (현재 구현)

```
✅ Phase 1 (완료):
  - 8×8 그리드 생성
  - 드래그 입력 처리
  - 8방향 연결 감지
  - 경로 검증 (색상, 인접성)
  - LineRenderer 시각화
  - Auto-backtracking

✅ Phase 2 (완료):
  - 블록 제거 시스템
  - 블록 드롭 애니메이션
  - 빈 칸 재생성
  - BlockPool 시스템
  - 블록 2종 (검, 방패)

🔶 Phase 3 (예정):
  - 블록 10종 전체 구현
  - 연쇄 보너스 시스템
  - 와일드카드 구현
  - 블록 애니메이션 polish
```

### Post-MVP 확장

```
🔶 Phase 4: 고급 메커니즘
  - 특수 블록 생성 (4개+ 연결 시)
  - 폭탄 블록 (주변 블록 파괴)
  - 라인 클리어 블록
  - 색상 변환 블록

🔶 Phase 5: 블록 빌딩 확장
  - 블록 업그레이드 시스템
  - 블록 제거 (덱 압축)
  - 블록 변환 (색상 변경)
  - 시너지 블록 (조합 효과)

🔶 Phase 6: 시각화 개선
  - 블록 생성 이펙트
  - 연결 파티클
  - 효과 발동 애니메이션
  - 연쇄 보너스 표시
```

---

## 🎯 디자인 원칙

### 핵심 철학

```
✅ 색상 = 직관적 카테고리
   - 빨강 = 공격, 파랑 = 방어, 노랑 = 골드
   - 시각적으로 즉시 인지

✅ 유연한 매칭
   - 최소 1개부터 가능 (유연성)
   - 긴 경로는 보너스 (보상)
   - 짧은 경로도 전략적 가치

✅ 블록 빌딩의 재미
   - 런마다 다른 조합
   - 시너지 구축
   - 특화 빌드 가능

✅ 순수 전략
   - 시간 제한 없음
   - 깊게 생각 가능
   - 실력 중심 게임플레이
```

### 밸런싱 원칙

```
블록 효과 크기:
- 공격 블록: 5-8 (기본)
- 방어 블록: 5-7 (기본)
- 회복 블록: 10-15 (희귀)
- 특수 블록: 상황 의존

색상 비율:
- 공격/방어: 각 25% (핵심)
- 골드: 15% (부가)
- 특수: 30% (다양성)
- 와일드: 5% (희귀)

추가 규칙:
✅ 강력한 효과 = 낮은 확률
✅ 기본 블록 = 높은 확률
✅ 색상 균형 유지
```

---

## 🔮 향후 확장

### 고급 블록 시스템

```
1. 블록 진화
   - 같은 블록 여러 개 획득 시 업그레이드
   - 예: 검 +5 → 검 +7 (3회 획득 시)

2. 조합 블록
   - 두 가지 효과 동시 적용
   - 예: 🔴🔵 검+방패: 공격 +5, 방어 +3

3. 조건부 블록
   - 특정 조건에서 효과 증폭
   - 예: HP 50% 이하 시 공격 2배

4. 연쇄 반응
   - 블록 제거 시 추가 블록 생성
   - 연쇄 폭발 효과
```

### 난이도 옵션

```
1. Time Attack
   - 턴당 30초 제한
   - 빠른 판단 요구

2. Hard Mode
   - 쓰레기 블록 증가 (40%)
   - 와일드카드 감소 (2%)
   - 높은 보상

3. Endless Mode
   - 무한 전투
   - 점점 어려워짐
   - 리더보드 경쟁
```

---

**작성일**: 2025-12-18
**버전**: 1.0
**담당**: 게임 시스템 디자인
