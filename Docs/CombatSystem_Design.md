# 전투 시스템 기획 문서

**게임 방식**: 순수 턴제 RPG 전투
**핵심**: 보드 매치 → 전투 효과 → 적 턴 → 반복
**관련 문서**: [EnemyDesign.md](EnemyDesign.md) - 적 디자인 상세

---

## 🎮 전투 흐름

### 기본 사이클
```
[전투 시작]
    ↓
[플레이어 턴]
  1. 보드에서 블록 연결
  2. 효과 즉시 발동 (공격/방어/회복 등)
  3. 턴 종료 버튼 (또는 자동)
    ↓
[적 턴]
  1. 예고된 행동 실행
  2. 플레이어 데미지 처리
  3. 다음 행동 예고
    ↓
[승패 판정]
  - 적 HP 0 → 승리
  - 플레이어 HP 0 → 패배
  - 아니면 플레이어 턴으로 복귀
```

### 턴 진행 예시
```
턴 1 - 플레이어:
  보드: 🔴⚔️ 5개 연결 → 공격 31
  적 HP: 50 → 19

턴 1 - 적:
  행동: 공격 8
  플레이어: 방어 0 → HP 100 → 92

턴 2 - 플레이어:
  보드: 🔵🛡️ 4개 연결 → 방어 22
  플레이어 방어: 0 → 22

턴 2 - 적:
  행동: 강공격 15 (예고됨)
  플레이어: 방어 22 → 0, HP 92 → 85
```

---

## 👤 플레이어 스탯

### 기본 스탯
```
HP (체력):
- 초기값: 100
- 최대값: 100 (유물로 증가 가능)
- 0 도달 → 게임 오버

방어력 (Defense):
- 초기값: 0
- 최대값: 30 (기본), 유물로 증가 가능
- 턴이 지나도 유지됨
- 적 공격 시 먼저 소모

골드 (Gold):
- 초기값: 0
- 상점에서 사용
- 전투 중 노란 블록으로 획득
```

### 방어력 시스템 상세
```
방어력의 역할:
- 적 공격 데미지를 먼저 흡수
- 방어력 > 적 공격 → HP 무손상
- 방어력 < 적 공격 → 남은 데미지만큼 HP 감소

예시 1:
  방어력 20, 적 공격 15
  → 방어력 20 - 15 = 5 (남음)
  → HP 손상 없음

예시 2:
  방어력 10, 적 공격 25
  → 방어력 10 - 25 = 0
  → HP 손상 15

예시 3:
  방어력 0, 적 공격 15
  → HP 손상 15
```

### 방어력 최대치
```
기본 최대: 30
유물로 증가 가능: +10, +15 등

이유:
- 무한 방어 방지
- 공격 vs 방어 밸런스 유지
- 전략적 선택 유도 (방어 쌓기 vs 공격)
```

---

## 👾 적 시스템 개요

> **상세 내용**: [EnemyDesign.md](EnemyDesign.md) 참조

### 적 기본 구조
```
모든 적:
- HP (체력)
- 공격력
- 행동 패턴 리스트
- 다음 행동 예고 시스템
```

### MVP 적 3종 (간략)
```
1. 슬라임 (초급)
   HP: 30, 공격: 5
   → 튜토리얼용, 단순 패턴

2. 고블린 (중급)
   HP: 50, 공격: 8
   → 강공격 예고 학습

3. 오크 (보스)
   HP: 150, 공격: 15
   → 분노 페이즈, 최종 도전
```

자세한 행동 패턴, 밸런싱, 공략법은 **[EnemyDesign.md](EnemyDesign.md)**를 참조하세요.

---

## ⚔️ 데미지 계산

### 플레이어 → 적
```
기본 공식:
최종 데미지 = 블록 효과 합계 × 연쇄 보너스 × 유물 배율

예시:
검 블록 5개 (5+5+5+5+5 = 25)
× 1.25 (5개 연쇄 보너스)
× 1.2 (유물: 공격 +20%)
= 37 데미지
```

### 적 → 플레이어
```
1단계: 방어력 계산
  방어력 >= 적 공격력?
    YES → 방어력만 감소, HP 무손상
    NO → 다음 단계

2단계: HP 데미지
  실제 데미지 = 적 공격력 - 방어력
  HP 감소

예시 1:
  방어력 20, 적 공격 15
  → 방어력 5 남음, HP 그대로

예시 2:
  방어력 10, 적 공격 25
  → 방어력 0, HP -15
```

---

## 🎯 전략적 요소

### 의사결정 포인트

#### 1. 공격 vs 방어
```
상황: 적 HP 20, 다음 턴 강공격 25 예고

선택 A: 지금 공격 30 → 승리
선택 B: 방어 25 쌓기 → 다음 턴 안전

→ 공격으로 끝낼까? 안전하게 방어?
```

#### 2. 회복 타이밍
```
상황: 플레이어 HP 30, 방어력 0, 포션 블록 보임

선택 A: 포션 3개 연결 → HP +30 회복
선택 B: 공격 → 포션은 나중에

→ 지금 회복? 공격 우선?
```

#### 3. 방어 축적
```
상황: 적이 2턴 후 강공격 예정

선택 A: 2턴간 방어 누적 (최대 30)
선택 B: 공격해서 먼저 처치

→ 방어 쌓기? 선제 공격?
```

### 예고 시스템 활용

```
적 행동 예고 → 플레이어 대응 가능

예시:
턴 N: 적 "강공격 준비 중..." (예고)
      → 플레이어: 방어 준비!

턴 N+1: 적 강공격 실행
        → 플레이어: 방어로 피해 최소화

전략적 가치:
✅ 예측 가능한 위협
✅ 공정한 난이도
✅ 전략적 대응 유도
```

> 적별 상세 공략법은 **[EnemyDesign.md](EnemyDesign.md)** 참조

---

## 📊 밸런싱

### 전투 시스템 밸런스

```
플레이어 평균 공격 (3개 블록):
- 검: 15
- 도끼: 24 (방어 -6)
- 화염: 9 + DOT 6

플레이어 HP: 100
최대 방어력: 30

밸런스 원칙:
✅ 플레이어가 공격적으로 유리
✅ 하지만 방어 관리 필수
✅ 10턴 내 적 처치 or 방어/회복 필요
```

> 적별 상세 밸런싱(HP, 공격력, 전투 길이)은 **[EnemyDesign.md](EnemyDesign.md)** 참조

---

## 🎨 UI 요소

### 전투 화면 구성
```
┌─────────────────────────────────┐
│ 적 정보                          │
│ ┌─────────────────────────┐     │
│ │   [오크 그림]            │     │
│ │   HP: ████████░░ 80/150 │     │
│ │   방어: ██ 10            │     │
│ │   다음: "강공격!"         │     │
│ └─────────────────────────┘     │
├─────────────────────────────────┤
│ 보드 (8×8)                      │
│ [블록 매치 영역]                 │
│                                 │
│                                 │
├─────────────────────────────────┤
│ 플레이어 정보                     │
│ HP: ████████████ 85/100         │
│ 방어: ███████░░░ 22/30          │
│ 골드: 💰 15                     │
│                                 │
│ [턴 종료] 버튼                   │
└─────────────────────────────────┘
```

### 적 행동 예고
```
행동 예고 시스템 (EnemyDesign.md 참조):
  - 아이콘 + 수치로 표시
  - 적 상단에 다음 턴 행동 표시

단일 행동 예시:
  ⚔️15   - 공격 15
  🛡️+10  - 방어 +10
  💪+3   - 힘 +3 버프

조합 행동 예시:
  ⚔️25💪+5  - 공격 25 + 힘 +5 획득
  ⚔️15🩹-2  - 공격 15 + 약화 -2 디버프

특수 행동:
  💢 분노  - 오크 HP 50% 이하 시 힘 +5 (영구)

UI 위치:
  ┌─────────────────────┐
  │   [오크 그림]        │
  │   HP: ████ 80/150   │
  │   행동: ⚔️25💪+5    │  ← 다음 행동
  │   💪5               │  ← 현재 상태
  └─────────────────────┘
```

### 데미지 표시
```
플레이어 공격:
  적에게 숫자 팝업 (빨강)
  "-25"

적 공격:
  플레이어에게 숫자 팝업
  방어 소모: "-15" (파랑)
  HP 소모: "-8" (빨강)

회복:
  "+20" (초록)
```

---

## 🎁 상태 효과 시스템

### DOT (Damage Over Time)
```
화염 블록으로 부여:
  DOT 2 데미지, 3턴

적 턴마다:
  "적이 화상으로 2 데미지를 받는다"
  적 HP -2

활용:
  짧은 전투: 별 효과 없음
  긴 전투: 누적 데미지 큼
```

### 버프/디버프
```
버프 블록 (갈색):
  "다음 공격 +50%" (1턴)
  플레이어 공격 배율 1.5배

회피 블록 (푸른):
  "30% 확률로 회피" (2턴)
  적 공격 시 30% 확률로 무효

적 디버프:
  독: 턴마다 HP 감소
  약화: 공격력 감소
```

---

## 📦 MVP 범위

### Week 1
```
✅ 기본 턴제 시스템
✅ 플레이어 HP/방어력
✅ 적 1종 (슬라임)
✅ 기본 공격만
✅ 데미지 계산
✅ 승패 판정
```

### Week 2
```
✅ 적 3종 전체
✅ 적 행동 패턴
✅ 강공격 예고 시스템
✅ 방어력 시스템 완성
✅ 전투 UI
✅ 상태 효과 (DOT, 버프)
```

### Week 3 (선택)
```
🔶 더 다양한 적 패턴
🔶 특수 전투 (엘리트, 보스 연출)
🔶 전투 애니메이션 polish
🔶 사운드 & 이펙트
```

---

## 💡 디자인 의도

### 왜 순수 턴제?
```
vs 실시간:
✅ 전략적 깊이 (천천히 생각)
✅ 보드 최적화에 집중
✅ 로그라이크와 어울림
✅ 스트레스 적음

시간제한 없음:
✅ 초보자 친화적
✅ 복잡한 상황도 대응 가능
✅ 모바일에서도 편함
```

### 왜 방어력 누적?
```
vs 일회성 방어:
✅ 미리 준비 가능 (강공격 대비)
✅ 방어 중심 빌드 가능
✅ 전략적 선택 증가
✅ 긴장감 유지 (최대치 제한)
```

### 왜 행동 예고?
```
vs 랜덤 공격:
✅ 대응 가능 (전략적)
✅ 긴장감 조성
✅ 실력 반영 (운보다 실력)
✅ 공정함
```

---

## 🎯 다중 적 전투 시스템 (Post-MVP)

> **관련 문서**: [EnemyPatterns.md](EnemyPatterns.md) - 다중 적 패턴 상세

### 시스템 개요

```
전장 구조:
┌─────────────────────────────┐
│  후방 (Back Row)             │
│  [적3]         [적4]         │
│                              │
│  전방 (Front Row)            │
│  [적1]         [적2]         │
└─────────────────────────────┘

특징:
- 최대 4체 동시 전투
- 전방/후방 포지셔닝
- 타겟팅 시스템
- 전략적 우선순위 설정
```

---

## ⚔️ 공격 처리 시스템

### 시스템 개요

```
플레이어가 블록을 연결하면:
1. 연결된 블록들의 처리 순서 결정
2. 공격 타입과 타겟이 같은 블록들을 그룹핑
3. 그룹별로 공격 실행
4. 과잉 데미지는 낭비됨
```

---

### 블록 처리 순서

#### 현재 규칙 (채택)
```
종류별 첫 블록 사용 순서

예시:
연결 순서: 소드 → 나이프 → 소드 → 대검 → 활 → 나이프

처리 순서:
1. 소드 (첫 등장 위치: 1번)
2. 나이프 (첫 등장 위치: 2번)
3. 대검 (첫 등장 위치: 4번)
4. 활 (첫 등장 위치: 5번)

→ 같은 종류는 함께 처리됨
```

#### 향후 변경 가능성
```
옵션 2: 블록 갯수 순
- 가장 많이 연결된 블록부터 처리
- 예: 소드 3개, 활 2개, 나이프 1개
  → 소드 → 활 → 나이프

옵션 3: 원래 순서 고정
- 연결한 순서 그대로 처리
- 예: 소드 → 나이프 → 소드 → 활
  → 소드 → 나이프 → 소드 → 활

현재는 옵션 1 사용, 추후 밸런싱에 따라 변경 가능
```

---

### 합산 규칙

#### 기본 원칙
```
합산 타입 블록은 "같은 타겟"에게만 합산됨
연속 타입 블록은 그룹핑되지 않음 (각각 별도 처리)

조건 (합산):
1. 공격 타입이 "합산"일 것
2. 타겟 대상이 동일할 것

→ 두 조건 모두 만족 시 합산
→ 하나라도 다르면 별도 공격

조건 (연속):
→ 항상 각 블록마다 별도 공격
```

#### 합산 예시

**예시 1: 합산 공격 그룹핑**
```
블록: 소드(합산,전방) + 소드(합산,전방) + 대검(합산,전방)

✅ 공격 타입: 모두 합산
✅ 타겟: 모두 전방

→ 3개 블록 데미지 합산하여 1회 공격
```

**예시 2: 타겟이 달라서 분리**
```
블록: 소드(합산,전방) + 활(합산,후방)

✅ 공격 타입: 모두 합산
❌ 타겟: 전방 vs 후방

→ 2번의 별도 공격
  1. 소드 → 전방 공격
  2. 활 → 후방 공격
```

**예시 3: 연속 공격은 그룹핑 안 됨**
```
블록: 나이프(연속,전방) + 나이프(연속,전방)

❌ 공격 타입: 연속 (그룹핑 안 됨)

→ 2번의 별도 공격
  1. 나이프 → 개별 공격
  2. 나이프 → 개별 공격
```

---

### 과잉 데미지 처리

```
과잉 데미지는 낭비됨

예시:
적 HP 10 남음
소드 5개 (25 데미지) 공격

→ 10 데미지만 들어감
→ 15 데미지는 낭비
→ 다음 적으로 넘어가지 않음

이유:
✅ 전략적 선택 유도 (과잉 방지)
✅ 예측 가능한 결과
✅ 시스템 단순화
```

---

### 종합 예시

#### 예시 1: 복합 블록 연결
```
연결 블록:
1. 소드(합산,전방)
2. 나이프(연속,전방)
3. 소드(합산,전방)
4. 대검(합산,전방)
5. 활(합산,후방)
6. 나이프(연속,전방)

그룹핑 결과:
그룹 1: [소드 + 소드 + 대검] (합산+전방)
그룹 2: [나이프] (연속+전방, 개별)
그룹 3: [나이프] (연속+전방, 개별)
그룹 4: [활] (합산+후방)

공격 처리 로그:
1. [소드 2개 + 대검 1개] → 전방 적 공격 (합산)
2. [나이프 1개] → 전방 적 공격 (개별)
3. [나이프 1개] → 전방 적 공격 (개별)
4. [활 1개] → 후방 적 공격 (합산)

총 4번 공격 실행
```

#### 예시 2: 과잉 데미지 발생
```
전장:
  전방: [적1 HP 15] [적2 HP 30]

블록: 소드(합산,전방) 5개 → 25 데미지

처리:
1. 타겟 선택: 적1 (가장 왼편)
2. 공격 실행: 25 데미지
3. 적1 HP: 15 - 25 = 0 (사망)
4. 과잉 데미지 10은 낭비
5. 적2는 무사함

결과:
  전방: [적2 HP 30]
```

#### 예시 3: 연속 vs 합산 비교
```
상황: 전방 [적1 HP 10] [적2 HP 20]

케이스 A: 합산 공격
블록: 소드 5개 (합산,전방, 25 데미지)
→ 적1에게 25 데미지 → 10만 적용, 15 낭비
→ 적1 사망, 적2 무사

케이스 B: 연속 공격 (Post-MVP)
블록: 나이프 5개 (연속,전방, 5 데미지씩)
→ 적1에게 5 데미지 (사망, 과잉 없음)
→ 적2에게 5 데미지 (사망, 과잉 없음)
→ 적3에게 5 데미지 × 3회 (HP 5 남음)
→ 더 효율적!

전략적 차이:
✅ 합산: 단일 고데미지, 방어력 관통 유리
✅ 연속: 다중 타겟 처리, 과잉 데미지 최소화
```

---

### 공격 유형 (Attack Types)

#### 1. 합산 공격 (Summed Attack)
```
연결된 블록의 총 데미지를 한 번에 적용

메커니즘:
- 모든 블록 효과를 합산
- 단일 타겟에게 한 번에 적용
- 방어력을 한 번만 계산

예시:
검 블록 5개 (5+5+5+5+5 = 25)
→ 타겟에게 25 데미지 (단일 공격)

장점:
✅ 방어력 관통에 유리
✅ 높은 단일 타겟 데미지
✅ 버스트 딜링

단점:
⚠️ 단일 타겟만 공격
⚠️ 과잉 데미지 낭비 가능

적용 블록:
- 검 (SWORD): 합산, 전방
- 도끼 (AXE): 합산, 무작위
- 화염 (FIRE): 합산, 전체
```

#### 2. 연속 공격 (separated Attack)
```
연결된 블록마다 개별 공격 실행

메커니즘:
- 각 블록이 순차적으로 공격
- 타겟은 동일하거나 변경 가능
- 방어력을 매번 계산

예시:
검 블록 5개 (5+5+5+5+5)
→ 5 데미지 × 5회 공격

장점:
✅ 다중 적 처치 가능
✅ 온힛 효과 다중 발동
✅ 방어력 낮은 적 효율적 제거

단점:
⚠️ 방어력에 약함 (매번 감소)
⚠️ 개별 데미지 낮음

활용 예시:
- 저체력 적 다수 처리
- 반격/온힛 효과 발동
- 분산 딜링

참고: Post-MVP Phase 2 예정
```

---

### 타겟팅 시스템 (Targeting Types)

#### 1. 전방 타겟팅 (Front)
```
전방 적 우선 공격

우선순위:
1. 전방 적 중 HP 가장 낮은 적
2. 전방에 적 없으면 후방 공격

전략적 의미:
- 탱커 제거 우선
- 안정적인 타겟팅
- 기본 공격 패턴

적용:
🔴⚔️ 검 - 전방 공격
```

#### 2. 후방 타겟팅 (Back)
```
후방 적 우선 공격

우선순위:
1. 후방 적 중 HP 가장 낮은 적
2. 후방에 적 없으면 전방 공격

전략적 의미:
- 힐러/딜러 제거 우선
- 위협 제거
- 전술적 선택

활용 예시:
전장:
  후방: [힐러 HP30]  [궁수 HP25]
  전방: [전사 HP80]  [방패병 HP100]

후방 타겟팅 공격 25
→ 궁수 처치 (HP 낮음)
→ 위협 제거 성공

참고: Post-MVP Phase 2 예정
```

#### 3. 무작위 타겟팅 (Random)
```
무작위 적 공격

메커니즘:
- 모든 생존 적 중 랜덤 선택
- 전방/후방 무관
- 예측 불가능

전략적 의미:
- 높은 데미지, 불확실성
- 위험-보상 트레이드오프
- 운 요소 추가

적용:
🔴🪓 도끼 - 무작위 공격

장점:
✅ 후방 적도 공격 가능
✅ 높은 데미지 (도끼 특성)

단점:
⚠️ 타겟 제어 불가
⚠️ 저체력 적 놓칠 수 있음

참고: Post-MVP Phase 2 예정
```

#### 4. 전체 타겟팅 (All / AOE)
```
모든 적에게 동시 공격

메커니즘:
- 모든 생존 적에게 동일 데미지
- 전방/후방 모두
- 광역 효과

전략적 의미:
- 다중 적 처리
- 효율적 딜링
- 클리어링 능력

적용:
🔴🔥 화염 - 전체 공격 (AOE)

예시:
전장:
  후방: [적3 HP20]  [적4 HP15]
  전방: [적1 HP30]  [적2 HP25]

화염 3개 연결 (공격 6×3 = 18)
→ 모든 적에게 18 데미지

결과:
  후방: [적3 HP2]  [적4 사망]
  전방: [적1 HP12]  [적2 HP7]

장점:
✅ 다중 적 동시 처리
✅ 총 데미지 효율 높음
✅ 클리어 속도

단점:
⚠️ 개별 데미지 낮음
⚠️ 과잉 킬 시 낭비

참고: Post-MVP Phase 2 예정
```

---

### 타겟팅 우선순위 상세

```
전방 타겟팅:
1. 가장 왼편 적 대상

후방 타겟팅:
1. 가장 오른편 적 대상

무작위 타겟팅:
1. 생존 적 중 완전 랜덤
2. 동일 확률

전체 타겟팅:
1. 모든 생존 적 동시 공격
2. 우선순위 없음
```

---

### 전략적 시너지

```
시나리오 1: 전방 탱커 돌파
전장:
  후방: [딜러 HP30]
  전방: [탱커 HP80, 방어10]

전략:
1. 검 (전방, 합산) - 탱커 데미지
2. 도끼 (무작위, 합산) - 탱커 OR 딜러
3. 화염 (전체, 합산) - 모두에게 광역 데미지

→ 탱커 제거 OR 딜러 저격

시나리오 2: 다중 저체력 적
전장:
  후방: [적3 HP15]  [적4 HP12]
  전방: [적1 HP18]  [적2 HP10]

전략:
1. 화염 (전체) - 모두에게 18 데미지
   → 적4, 적2 처치
   → 적1, 적3 저체력

2. 검 (전방) - 적1 마무리
   → 적3만 남음

시나리오 3: 후방 힐러 저격
전장:
  후방: [힐러 HP25]  [딜러 HP30]
  전방: [탱커1 HP50]  [탱커2 HP60]

문제: 검(전방)으로는 힐러 공격 불가

해결책:
1. 도끼 (무작위) - 운에 맡김
2. 화염 (전체) - 모두 공격
3. Post-MVP: 후방 타겟팅 블록 추가
```

---

### 밸런싱 고려사항

```
합산 vs 연속:
- 합산: 방어 관통 유리(큰 단일 데미지), 단일 타겟
- 연속: 과잉 데미지 적음, 방어 관통 불리

타겟팅 밸런스:
- 전방: 안정적, 예측 가능
- 후방: 전술적, 위협 제거
- 무작위: 고위험고보상
- 전체: AOE 딜링, 낮은 개별 데미지

블록 밸런스 (MVP):
┌──────┬────────┬──────────┬──────┐
│ 블록 │ 공격   │ 타겟팅   │ 특징 │
├──────┼────────┼──────────┼──────┤
│ 검   │ 합산   │ 전방     │ 기본 │
│ 도끼 │ 합산   │ 무작위   │ 위험 │
│ 화염 │ 합산   │ 전체     │ AOE  │
└──────┴────────┴──────────┴──────┘

→ 각 블록이 명확한 역할
→ 상황별 최적 선택 존재
→ 전략적 깊이
```

---

## 🔮 향후 확장

### 전투 시스템 확장
```
Phase 1:
✅ 다중 적 전투 시스템 설계 (완료)
✅ 공격 유형: 합산/연속
✅ 타겟팅: 전방/후방/무작위/전체

Phase 2:
- 연속 공격 구현
- 후방 타겟팅 블록 추가
- 온힛 효과 시스템

Phase 3:
- 적 포지셔닝 변경 (전방↔후방)
- 환경 효과
- 특수 전투 조건
```

### 적 관련 확장
> 상세 내용은 **[EnemyDesign.md](EnemyDesign.md)** 참조

```
- 추가 일반 적 (10종)
- 엘리트 시스템
- 보스 배리에이션 (3종)
- 특수 메커니즘 (소환, 변신)
```

### 난이도 옵션
```
- Normal: 기본
- Hard: 적 강화 + 추가 보상
- Ascension: 무한 난이도 시스템
```

---

**작성일**: 2025-12-12
**최종 수정**: 2025-12-18
**버전**: 1.1 (다중 적 전투 시스템 추가)
**담당**: 게임 디자인
